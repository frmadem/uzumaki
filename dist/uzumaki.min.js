// uzumaki - v0.0.1 (2015-07-23)
function Message(a,b,c){this.name=a,this.args=b,this.callback=c,this.type=this.__type()}function functionSerializer(a,b){return"function"==typeof b?b.toString():b}function functionUnserializer(a,b){if(""===a)return b;if("string"==typeof b){var c=/function[^\(]*\(([^\)]*)\)[^\{]*{([^\}]*)\}/,d=b.match(c);if(d){var e=d[1].split(",").map(function(a){return a.replace(/\s+/,"")});return new Function(e,d[2])}}return b}function Mailbox(){this.__stack=[]}function Actor(a,b){this.name=function(){return a},this.__onWork=!1,this.__initMailbox(),this.__initReceive(b)}function __createCallback(a){var b=Object.keys(a);return function(c){var d=test_literal(c,a,b);d?d(c):a["*"](c)}}function test_literal(a,b,c){var d=_.indexOf(c,a);return-1!=d?c(d):!1}function ActorInProcess(a,b){this.name=function(){return a},this.modulePath=b}function registry(){return REGISTRY===!1&&(REGISTRY=new Registry),REGISTRY}function Registry(){this.__localActors={},this.__inProcessActors={}}function isAbbreviated(a){return a.match(/\.(.+)/)}function isLocalActor(a){return a.match(/^\w+$/)}function isActorInProcess(a){return a.match(/^p\#(.+)/)}var p=Message.prototype;p.serialize=function(){return JSON.stringify(this,functionSerializer)},p.unserialize=function(a){var b=JSON.parse(a,functionUnserializer);return this.name=b.name,this.args=b.args,this.callback=b.callback,this},p.__type=function(){return"NORMAL"},module.exports=Message;var Message=require("./message.js"),p=Mailbox.prototype;p.newMessage=function(a){this.__stack.push(a)},p.getMessage=function(){return this.__stack.shift()},module.exports=Mailbox;var Mailbox=require("./mailbox.js"),Message=require("./message.js"),p=Actor.prototype;p.start=function(){},p.send=function(a,b,c){var d=this.__createMessage(a,b,c);this.__mailbox.newMessage(d),setTimeout(function(){this.__work()}.bind(this),0)},p.__work=function(){if(this.__onWork!==!0){this.__onWork=!0;for(var a=!0;a;){var b=this.__mailbox.getMessage();b?this.__runMessage(b):a=!1}this.__onWork=!1}},p.__runMessage=function(a){var b=this.__api[a.name];b(a)},p.__initMailbox=function(){this.__mailbox=new Mailbox},p.__initReceive=function(a){if("object"!=typeof a)throw"uzumaki.Actor.new: receive is not an object";this.__api={};var b=Object.keys(a);b.forEach(function(b){var c=a[b];this.__api[b]=function(a){var b=c.apply(this,a.args);return a.callback?void a.callback(b):b}.bind(this)}.bind(this))},p.__createMessage=function(a,b,c){return new Message(a,b,c)},module.exports=Actor;var _=require("underscore-node");module.exports.createCallback=function(a){return"function"==typeof a?a:"object"==typeof a?__createCallback(a):void 0};var Actor=require("./actor.js"),Child=require("child_process");ActorInProcess.prototype=Object.create(Actor.prototype),ActorInProcess.prototype.constructor=ActorInProcess;var p=ActorInProcess.prototype;p.start=function(){var a=Child.fork(this.modulePath);this.ctl=a},module.exports=ActorInProcess;var Actor=require("./actor.js"),ActorInProcess=require("./actor_process.js"),REGISTRY=!1,p=Registry.prototype;p.register=function(a,b){isActorInProcess(a)?this.__registerActorInProcess(a,b):isLocalActor(a)&&this.__registerLocalActor(a,b)},p.__registerLocalActor=function(a,b){this.__localActors[a]=new Actor(a,b)},p.__registerActorInProcess=function(a,b){this.__inProcessActors[a]=new ActorInProcess(a,b),this.__inProcessActors[a].start()},p.deliverMessage=function(a,b,c){var d,e=a;if(c=createCallback(),isAbbreviated(e)){var f=e.split(/\./);e=f[0],d=f[1]}isLocalActor(e)&&this.__deliverMessageLocalActor(e,d,b,c)},p.__deliverMessageLocalActor=function(a,b,c,d){var e=this.__localActors[a];e.send(b,c,d)},module.exports.registry=registry;